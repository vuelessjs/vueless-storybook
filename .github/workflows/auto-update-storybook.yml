name: Auto Update Storybook

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions: write-all

jobs:
  update-storybook:
    name: 'Auto-Update: Storybook'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          registry-url: https://registry.npmjs.org/
      - run: npm install -g npm@latest
      - run: npm ci

      - name: Check for Storybook updates
        id: check-updates
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').dependencies.storybook.replace('^', '')")
          echo "Current version: $CURRENT_VERSION"

          LATEST_VERSION=$(npm view storybook version)
          echo "Latest version: $LATEST_VERSION"
          
          CURRENT_MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          CURRENT_MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          CURRENT_PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          LATEST_MAJOR=$(echo $LATEST_VERSION | cut -d. -f1)
          LATEST_MINOR=$(echo $LATEST_VERSION | cut -d. -f2)
          LATEST_PATCH=$(echo $LATEST_VERSION | cut -d. -f3)
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT_MAJOR" != "$LATEST_MAJOR" ]; then
            echo "Major version change detected ($CURRENT_MAJOR -> $LATEST_MAJOR). Skipping update."
            echo "should_update=false" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "Update available: $CURRENT_VERSION -> $LATEST_VERSION"
            echo "should_update=true" >> $GITHUB_OUTPUT
          else
            echo "Already on latest version"
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Storybook packages
        if: steps.check-updates.outputs.should_update == 'true'
        run: |
          LATEST_VERSION=${{ steps.check-updates.outputs.latest_version }}
          npm install \
            storybook@^$LATEST_VERSION \
            @storybook/addon-docs@^$LATEST_VERSION \
            @storybook/addon-links@^$LATEST_VERSION \
            @storybook/addon-themes@^$LATEST_VERSION \
            @storybook/vue3-vite@^$LATEST_VERSION \
            eslint-plugin-storybook@^$LATEST_VERSION

      - name: Commit and push changes
        if: steps.check-updates.outputs.should_update == 'true'
        id: commit-changes
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git add package.json package-lock.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "changes_committed=false" >> $GITHUB_OUTPUT
          else
            CURRENT_VERSION=${{ steps.check-updates.outputs.current_version }}
            LATEST_VERSION=${{ steps.check-updates.outputs.latest_version }}
            git commit -m "feat: update Storybook from $CURRENT_VERSION to $LATEST_VERSION"
            git push origin ${{ github.ref_name }}
            echo "changes_committed=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine release type
        if: steps.commit-changes.outputs.changes_committed == 'true'
        id: release-type
        run: |
          CURRENT_VERSION=${{ steps.check-updates.outputs.current_version }}
          LATEST_VERSION=${{ steps.check-updates.outputs.latest_version }}

          CURRENT_MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          LATEST_MINOR=$(echo $LATEST_VERSION | cut -d. -f2)

          if [ "$CURRENT_MINOR" != "$LATEST_MINOR" ]; then
            echo "Minor version change detected"
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            echo "Patch version change detected"
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Trigger release workflow
        if: steps.commit-changes.outputs.changes_committed == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: storybook-auto-update
          client-payload: '{"release_type": "${{ steps.release-type.outputs.type }}"}'

